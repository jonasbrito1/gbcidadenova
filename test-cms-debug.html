<!DOCTYPE html>
<html>
<head>
    <title>Debug CMS React</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        .loading { color: blue; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
        iframe { width: 100%; height: 600px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Debug CMS React - Gracie Barra</h1>

    <div class="test-section">
        <h2>1. Abrir CMS no iframe</h2>
        <button onclick="abrirCMS()">Abrir CMS Interface</button>
        <div id="cms-container"></div>
    </div>

    <div class="test-section">
        <h2>2. Teste Sequencial Completo</h2>
        <button onclick="testeCompleto()">Executar Teste Completo</button>
        <div id="result-complete"></div>
    </div>

    <div class="test-section">
        <h2>3. Atualizar Texto</h2>
        <button onclick="testUpdateText()">Atualizar T√≠tulo Principal</button>
        <div id="result-text"></div>
    </div>

    <div class="test-section">
        <h2>4. Logs em Tempo Real</h2>
        <button onclick="clearLogs()">Limpar Logs</button>
        <div id="logs" style="background: #000; color: #0f0; padding: 10px; font-family: monospace; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <script>
        const apiBase = 'http://localhost:3011/api/cms';
        let logCount = 0;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#fff';
            logsDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function abrirCMS() {
            const container = document.getElementById('cms-container');
            container.innerHTML = `
                <h3>Interface CMS</h3>
                <iframe src="http://localhost:3010/app/cms"></iframe>
            `;
        }

        async function testUpdateText() {
            const resultDiv = document.getElementById('result-text');
            resultDiv.innerHTML = '<span class="loading">Atualizando texto...</span>';

            const novoTexto = `Gracie Barra - Debug Test ${new Date().toLocaleTimeString()}`;

            try {
                log(`Atualizando texto para: ${novoTexto}`, 'info');

                const response = await fetch(`${apiBase}/conteudos/1`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ valor: novoTexto })
                });

                const data = await response.json();

                if (data.success) {
                    log(`‚úÖ Texto atualizado com sucesso: ${data.data.valor}`, 'success');
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Texto atualizado!</div>
                        <div>üìù Novo valor: ${data.data.valor}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;

                    // Verificar se mudou no banco
                    setTimeout(async () => {
                        log('Verificando se a mudan√ßa persistiu...', 'info');
                        const checkResponse = await fetch(`${apiBase}/secoes/1`);
                        const checkData = await checkResponse.json();
                        const conteudo1 = checkData.data.conteudos.find(c => c.id === 1);
                        log(`Valor atual no banco: ${conteudo1.valor}`, conteudo1.valor === novoTexto ? 'success' : 'error');
                    }, 1000);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }

        async function testeCompleto() {
            const resultDiv = document.getElementById('result-complete');
            resultDiv.innerHTML = '<span class="loading">Executando teste completo...</span>';

            try {
                log('üöÄ Iniciando teste completo', 'info');

                // 1. Listar se√ß√µes
                log('1. Listando se√ß√µes...', 'info');
                const secoesResponse = await fetch(`${apiBase}/secoes`);
                const secoesData = await secoesResponse.json();
                log(`Se√ß√µes encontradas: ${secoesData.data.length}`, 'success');

                // 2. Carregar se√ß√£o Hero
                log('2. Carregando se√ß√£o Hero...', 'info');
                const heroResponse = await fetch(`${apiBase}/secoes/1`);
                const heroData = await heroResponse.json();
                log(`Conte√∫dos na se√ß√£o Hero: ${heroData.data.conteudos.length}`, 'success');

                // 3. Atualizar texto
                const novoTexto = `Teste Completo ${new Date().toLocaleTimeString()}`;
                log(`3. Atualizando texto para: ${novoTexto}`, 'info');
                const updateResponse = await fetch(`${apiBase}/conteudos/1`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ valor: novoTexto })
                });
                const updateData = await updateResponse.json();
                log(`Texto atualizado: ${updateData.success}`, updateData.success ? 'success' : 'error');

                // 4. Verificar mudan√ßa
                log('4. Verificando se a mudan√ßa persistiu...', 'info');
                const checkResponse = await fetch(`${apiBase}/secoes/1`);
                const checkData = await checkResponse.json();
                const conteudo1 = checkData.data.conteudos.find(c => c.id === 1);
                const mudancaPersistiu = conteudo1.valor === novoTexto;
                log(`Mudan√ßa persistiu: ${mudancaPersistiu}`, mudancaPersistiu ? 'success' : 'error');

                resultDiv.innerHTML = `
                    <div class="${mudancaPersistiu ? 'success' : 'error'}">
                        ${mudancaPersistiu ? '‚úÖ' : '‚ùå'} Teste completo ${mudancaPersistiu ? 'PASSOU' : 'FALHOU'}
                    </div>
                    <div>üìä Detalhes no console de logs</div>
                `;

            } catch (error) {
                log(`‚ùå Erro no teste completo: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }

        // Executar teste autom√°tico
        window.onload = function() {
            log('üîß Debug CMS carregado', 'info');
            setTimeout(() => {
                log('Executando teste autom√°tico...', 'info');
                testeCompleto();
            }, 2000);
        };
    </script>
</body>
</html>